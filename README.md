# AGS API MCP Server

A simple Streamable HTTP-based MCP (Model Context Protocol) server built with TypeScript that supports OAuth authorization.

## Features

- **HTTP-based MCP Server**: Implements the Model Context Protocol over HTTP
- **OAuth 2.1 with PKCE**: Secure authentication using OAuth 2.1 with Proof Key for Code Exchange
- **JWT Token Verification**: Secure token validation using JWKS (JSON Web Key Set)
- **Static OAuth Client**: Simplified OAuth flow using pre-configured client credentials
- **User Context Propagation**: Authenticated user context passed to all MCP tools
- **Example Tools**: Built-in tools for demonstration and testing
- **TypeScript**: Full type safety and modern JavaScript features
- **Express.js**: Fast and lightweight web framework

## Prerequisites

- Node.js 18+ 
- npm or yarn
- OAuth provider (Google, GitHub, Auth0, etc.)

## Installation

1. Clone the repository:
```bash
git clone <repository-url>
cd ags-api-mcp
```

2. Install dependencies:
```bash
npm install
```

3. Set up environment configuration:
```bash
npm run setup
```
This will create a `.env` file from the template and generate a secure JWT secret.

4. Configure your OAuth settings in `.env`:
```env
# OAuth Configuration
OAUTH_CLIENT_ID=your_client_id
OAUTH_CLIENT_SECRET=<redacted>
OAUTH_REDIRECT_URI=http://localhost:3000/oauth/callback
OAUTH_AUTHORIZATION_URL=https://your-provider.com/oauth/authorize
OAUTH_TOKEN_URL=https://your-provider.com/oauth/token
OAUTH_USER_INFO_URL=https://your-provider.com/oauth/userinfo

# JWT Configuration
JWT_SECRET=<redacted>
JWT_EXPIRES_IN=1h

# Server Configuration
PORT=3000
NODE_ENV=development
```

## Usage

### Development Mode
```bash
npm run dev
```

### Production Mode
```bash
npm run build
npm start
```

### Watch Mode (for development)
```bash
npm run watch
```

### Environment Setup
```bash
# Set up environment variables
npm run setup

# Test with environment variables
npm run test:env
```

### Development Mode (Skip Authentication)
For development and testing, you can disable JWT validation:

```bash
# Set DISABLE_JWT_VALIDATION=true in .env
echo "DISABLE_JWT_VALIDATION=true" >> .env

# Or run with environment variable
DISABLE_JWT_VALIDATION=true npm run dev
```

When JWT validation is disabled:
- Any token (or no token) will be accepted
- User will be set to anonymous
- Useful for API testing without OAuth setup

## Environment Variables

The server uses the following environment variables (configured in `.env`):

### Required Variables
- `PORT` - Server port (default: 3000)
- `NODE_ENV` - Environment mode (development/production)
- `LOG_LEVEL` - Logging level (debug, info, warn, error, fatal)

### OAuth Variables (Optional)
- `OAUTH_CLIENT_ID` - OAuth client ID
- `OAUTH_CLIENT_SECRET` - OAuth client secret
- `OAUTH_REDIRECT_URI` - OAuth redirect URI
- `OAUTH_AUTHORIZATION_URL` - OAuth authorization URL
- `OAUTH_TOKEN_URL` - OAuth token URL
- `OAUTH_USER_INFO_URL` - OAuth user info URL

### JWT Variables
- `JWT_SECRET` - JWT signing secret (auto-generated by setup script)
- `JWT_EXPIRES_IN` - JWT expiration time (default: 1h)
- `DISABLE_JWT_VALIDATION` - Disable JWT validation for development/testing (default: false)

## API Endpoints

### Authentication
- `GET /auth/login` - Initiate OAuth login
- `GET /oauth/callback` - OAuth callback handler
- `GET /auth/logout` - Logout and clear session

### MCP Protocol
- `POST /mcp` - Main MCP endpoint (requires authentication)

### Health Check
- `GET /health` - Server health status

### Authentication Helper

## MCP Tools

The server includes several example tools:

### 1. Echo
Echo back the input message.
```json
{
  "name": "echo",
  "arguments": {
    "message": "Hello, World!"
  }
}
```

### 2. Get Time
Get the current timestamp.
```json
{
  "name": "get_time",
  "arguments": {}
}
```

### 3. Calculate
Perform basic arithmetic calculations.
```json
{
  "name": "calculate",
  "arguments": {
    "expression": "2 + 2 * 3"
  }
}
```

### 4. System Info
Get system information.
```json
{
  "name": "get_system_info",
  "arguments": {}
}
```

### 5. Generate Random String
Generate a random string with customizable options.
```json
{
  "name": "generate_random_string",
  "arguments": {
    "length": 10,
    "includeNumbers": true,
    "includeSymbols": false
  }
}
```

### 6. Convert Case
Convert text to different cases.
```json
{
  "name": "convert_case",
  "arguments": {
    "text": "hello world",
    "case": "upper"
  }
}
```

## MCP Protocol Usage

### Initialize
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2024-11-05",
    "capabilities": {},
    "clientInfo": {
      "name": "example-client",
      "version": "1.0.0"
    }
  }
}
```

### List Tools
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "method": "tools/list"
}
```

### Call Tool
```json
{
  "jsonrpc": "2.0",
  "id": 3,
  "method": "tools/call",
  "params": {
    "name": "echo",
    "arguments": {
      "message": "Hello, MCP!"
    }
  }
}
```

## OAuth Configuration

### Simplified OAuth Flow
This MCP server uses a **simplified OAuth 2.1 flow** with static client credentials:

1. **No Dynamic Registration**: Uses pre-configured OAuth client credentials
2. **Direct OAuth Flow**: mcp-remote connects directly to AccelByte OAuth server
3. **JWT Verification**: Server validates tokens using AccelByte's JWKS
4. **User Context**: Authenticated user information passed to all tools

### AccelByte OAuth Example (mcp-remote mode)
```env
# OAuth Discovery URLs (for metadata only - mcp-remote handles OAuth)
OAUTH_AUTHORIZATION_URL=https://development.accelbyte.io/iam/v3/oauth/authorize
OAUTH_TOKEN_URL=https://development.accelbyte.io/iam/v3/oauth/token
OAUTH_USER_INFO_URL=https://development.accelbyte.io/iam/v3/public/users/userinfo

# OIDC Configuration (for JWT token verification)
JWKS_URI=https://development.accelbyte.io/iam/v3/oauth/jwks
JWT_ISSUER=https://development.accelbyte.io
JWT_AUDIENCE=<your_client_id>
JWT_ALGORITHMS=RS256
```

**Note**: `OAUTH_CLIENT_ID` and `OAUTH_CLIENT_SECRET` are not needed in mcp-remote mode since mcp-remote handles OAuth using its static credentials.

### mcp-remote Configuration
Configure mcp-remote to use the same static OAuth credentials:

```json
{
  "mcpServers": {
    "ags-api-mcp": {
      "command": "npx",
      "args": [
        "mcp-remote",
        "http://localhost:3000/mcp",
        "3334",
        "--host", "localhost",
        "--static-oauth-client-info",
        "{ \"client_id\": \"<your_client_id>\", \"client_secret\": \"<redacted>\" }"
      ]
    }
  }
}
```

### Simplified OAuth Flow Sequence

1. **MCP Client** connects to **mcp-remote** (port 3334)
2. **mcp-remote** discovers OAuth server metadata from **MCP Server**
3. **mcp-remote** uses static OAuth credentials to authenticate with **AccelByte IAM**
4. **AccelByte IAM** redirects user for authentication
5. **User** authenticates and authorizes the application
6. **AccelByte IAM** returns authorization code to **mcp-remote**
7. **mcp-remote** exchanges code for access token using static credentials
8. **mcp-remote** forwards MCP requests to **MCP Server** with access token
9. **MCP Server** validates JWT token using AccelByte's JWKS
10. **MCP Server** passes user context to tools for authenticated API calls

**Key Benefits:**
- ✅ **No Dynamic Registration** - Uses pre-configured credentials
- ✅ **Simplified Flow** - Fewer steps and dependencies
- ✅ **Better Performance** - No unnecessary API calls
- ✅ **Easier Configuration** - Static credentials in one place

## Security Features

- **Helmet.js**: Security headers
- **CORS**: Cross-origin resource sharing configuration
- **JWT**: Secure token-based authentication
- **HTTP-only Cookies**: Secure session management
- **Input Validation**: Tool parameter validation
- **Error Handling**: Comprehensive error handling

## Development

### Project Structure
```
src/
├── index.ts              # Main server entry point
├── mcp-server.ts         # MCP protocol implementation
├── oauth-middleware.ts   # OAuth authentication middleware
└── tools/
    └── static-tools.ts  # Example MCP tools
```

### Adding New Tools

1. Create a new tool class or add methods to `StaticTools`
2. Register the tool in `src/index.ts`:
```typescript
mcpServer.registerTool('tool_name', toolInstance.method.bind(toolInstance));
```

3. Optionally, provide a schema for better tool discovery:
```typescript
mcpServer.registerTool('tool_name', handler, {
  name: 'tool_name',
  description: 'Tool description',
  inputSchema: {
    type: 'object',
    properties: {
      param1: { type: 'string', description: 'Parameter description' }
    },
    required: ['param1']
  }
});
```

## Testing

Test the server using curl or any HTTP client:

1. **Health Check**:
```bash
curl http://localhost:3000/health
```

2. **OAuth Login** (redirects to OAuth provider):
```bash
curl -L http://localhost:3000/auth/login
```

3. **MCP Request** (after authentication):
```bash
curl -X POST http://localhost:3000/mcp \
  -H "Content-Type: application/json" \
  -H "Cookie: auth_token=your_jwt_token" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list"
  }'
```
## Clean up
With mcp-remote, clean up the token caches under ~/.mcp-auth, e.g. 

```
rm -rf ~/.mcp-auth
```

## License

MIT License - see LICENSE file for details.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## Support

For issues and questions, please open an issue in the repository.
