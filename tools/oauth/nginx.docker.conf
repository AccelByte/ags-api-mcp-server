# Nginx configuration for Docker Compose setup
# Routes requests to both OAuth server and MCP server on the same hostname

upstream oauth_backend {
    server oauth-server:3001;
}

upstream mcp_backend {
    server mcp-server:3000;
}

server {
    listen 80;
    server_name localhost;

    # OAuth endpoints - route to OAuth server
    location /oauth {
        proxy_pass http://oauth_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # OAuth discovery endpoints - route to OAuth server
    location /.well-known/oauth-authorization-server {
        proxy_pass http://oauth_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /.well-known/jwks.json {
        proxy_pass http://oauth_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP discovery endpoint - route to MCP server
    location /.well-known/oauth-protected-resource {
        proxy_pass http://mcp_backend;
        # Use $http_host to preserve the original Host header with port from client (e.g., localhost:8080)
        # Fallback to $host:$server_port if $http_host is not available
        set $forwarded_host $http_host;
        if ($forwarded_host = "") {
            set $forwarded_host $host:8080;
        }
        proxy_set_header Host $forwarded_host;
        proxy_set_header X-Forwarded-Host $forwarded_host;
        proxy_set_header X-Forwarded-Port 8080;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MCP endpoint - route to MCP server
    location /mcp {
        proxy_pass http://mcp_backend;
        # Use $http_host to preserve the original Host header with port from client
        set $forwarded_host $http_host;
        if ($forwarded_host = "") {
            set $forwarded_host $host:8080;
        }
        proxy_set_header Host $forwarded_host;
        proxy_set_header X-Forwarded-Host $forwarded_host;
        proxy_set_header X-Forwarded-Port 8080;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Increase timeouts for long-running requests
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Health check endpoints
    location /health {
        proxy_pass http://mcp_backend;
        proxy_set_header Host $host;
    }

    location /oauth-health {
        proxy_pass http://oauth_backend/health;
        proxy_set_header Host $host;
    }

    # Root endpoint - show info
    location / {
        return 200 '{"service":"MCP Server with OAuth","endpoints":{"mcp":"/mcp","oauth":"/oauth","health":"/health","oauth-health":"/oauth-health"}}';
        add_header Content-Type application/json;
    }
}
